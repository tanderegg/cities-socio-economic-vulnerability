
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)

data_path = "./data/census_mexico.csv"
# data_path = "https://storage.googleapis.com/socio-economic-vulnerability/data/processed/census_mexico.csv"

data = read.csv(data_path,sep = ",")




# Define UI for application that draws a histogram
ui <- fluidPage(
    titlePanel("Basic DataTable"),
    
    # Create a new Row in the UI for selectInputs
    fluidRow(
        
        # select entity level
        column(4,
               selectizeInput(inputId = "entity_level",
                              label = "entity_level:",
                              # choices = c("All",
                              #             unique(as.character(data$Level))),
                              choices = unique(as.character(data$Level)),
                              selected = unique(as.character(data$Level))[1],
                              multiple = FALSE)
        ),
        
        # select variable
        column(4,
               selectizeInput(inputId = "variable",
                              label = "variable:",
                              # choices =  c("All",
                              #              unique(as.character(data$Variable))),
                              choices = unique(as.character(data$Variable)),
                              selected = unique(as.character(data$Variable))[1],
                              multiple = TRUE)
        ),
        
        # select year
        column(4,
               selectizeInput(inputId = "year",
                              label = "year:",
                              choices = unique(as.character(data$Year)),
                              selected = unique(as.character(data$Year))[1],
                              multiple = TRUE)
        ),
        
        # select state
        column(4,
               selectizeInput(inputId = "state_name",
                              label = "state_name:",
                              choices = unique(as.character(data$State)),
                              selected = unique(as.character(data$State))[1],
                              multiple = TRUE)
        ),
        
        
        column(4,
               selectizeInput(inputId = "municipality_name",
                              label = "municipality_name:",
                              choices =  c("All",
                                           unique(as.character(data$Municipality))),
                              # selected = "All",
                              # choices =  unique(as.character(data$Municipality)),
                              # selected =  unique(as.character(data$Municipality))[1],
                              multiple = FALSE)
        ),
        column(4,
               selectizeInput(inputId = "locality_name",
                              label = "locality_name:",
                              choices =  c("All",
                                           unique(as.character(data$Locality))),
                              multiple = FALSE)
        )
    ),
    # Create a new row for the table.
    DT::dataTableOutput("table"),
    
    downloadButton("downloadData", "Download")
)

# Define server logic required to draw a histogram
server <- function(input, output, session) {
    
    observe({
        
        filtered_data = data %>%
            filter(Level == input$entity_level,
                   Variable %in% input$variable,
                   Year %in% input$year,
                   State %in% input$state_name)
        
        # Filter data based on selections
        output$table <- DT::renderDataTable(DT::datatable({
            
            # data = data %>%
            #     filter(Level == input$entity_level,
            #            Variable %in% input$variable,
            #            Year %in% input$year,
            #            State %in% input$state_name)
            
            
            if (input$municipality_name != "All") {
                filtered_data <- filtered_data[filtered_data$Municipality == input$municipality_name,]
            }
            
            if (input$locality_name != "All") {
                filtered_data <- filtered_data[filtered_data$Locality == input$locality_name,]
            }
            
            filtered_data
            
        }))
        
        # output data to download
        output$downloadData <- downloadHandler(
            filename = function() {
                paste("data-", Sys.Date(), ".csv", sep="")
            },
            content = function(file) {
                write.csv(filtered_data, file)
            }
        )
        
    })
    
}

# Run the application 
shinyApp(ui = ui, server = server)
