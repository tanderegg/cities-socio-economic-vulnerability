
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)


geo_levels = c("state","mun", "loc", "ageb") 

fixed_variables = c("entity_level","state_name","municipality_name","locality_name")


census_variables_df = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/mexico_census_variables_df.csv")
geo_levels_names = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/geo_levels_names.csv")

geo_levels_names[5243, "state_name"] = "Aguascalientes"
geo_levels_names[5243, "municipality_name"] = "All"
geo_levels_names[5243, "locality_name"] = "All"

# Define UI for application 
ui <- navbarPage("Census Dashboard",
                 # Mexico Tab ----
                 tabPanel("Mexico",
                          fluidRow(
                              # select entity level
                              column(4,
                                     selectizeInput(inputId = "entity_level",
                                                    label = "Geographical level:",
                                                    choices =  c("state","municipality","locality") ,
                                                    selected = "state",
                                                    multiple = FALSE)
                              ),
                              
                              # select variable
                              column(4,
                                     selectizeInput(inputId = "variable",
                                                    label = "Census variable:",
                                                    # choices = census_variables_df$census_variables,
                                                    # selected = census_variables_df$census_variables[1],
                                                    choices = c("d_dwg","d_1rm"),
                                                    selected = "d_dwg",
                                                    multiple = FALSE)
                              ),
                              
                              # select year
                              column(4,
                                     selectizeInput(inputId = "year",
                                                    label = "Year:",
                                                    choices = 2020,
                                                    selected = 2020,
                                                    multiple = FALSE)
                              ),
                              
                              # select state
                              column(4,
                                     selectizeInput(inputId = "state_name",
                                                    label = "State:",
                                                    choices = c("All",unique(geo_levels_names$state_name)),
                                                    # selected = unique(geo_levels_names$state_name)[1],
                                                    selected = "All",
                                                    multiple = FALSE)
                              ),
                              
                              
                              column(4,
                                     selectizeInput(inputId = "municipality_name",
                                                    label = "Municpality:",
                                                    choices =  NULL,
                                                    multiple = FALSE)
                              ),
                              column(4,
                                     selectizeInput(inputId = "locality_name",
                                                    label = "Locality:",
                                                    choices =  NULL,
                                                    multiple = FALSE)
                              )
                          ),
                          # Create a new row for the table.
                          # DT::dataTableOutput("table"),
                          column(6,
                                 DT::dataTableOutput("table"),
                                 downloadButton(outputId = "downloadData", 
                                                label = "Download data")
                          ),
                          column(6,
                                 leafletOutput("census_map", 
                                               height = 600)
                          )
                          
                 ),
                 # Brazil Tab ----
                 tabPanel("Brazil"),
                 # Colombia Tab ----
                 tabPanel("Colombia"),
                 # India Tab ----
                 tabPanel("India")
)



# Define server 
server <- function(input, output, session) {
    
    # Update municipality list based on selected state
    observeEvent(input$state_name,{
        updateSelectInput(session,
                          'municipality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"]),
                          # unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])[1],
                          choices=c("All", unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])),
                          selected = "All",
        )
    })
    
    # Update locality list based on selected state
    observeEvent(input$state_name,{
        updateSelectInput(session,
                          'locality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"]),
                          # selected = unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])[1],
                          choices=c("All",
                                    unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])),
                          selected = "All",
        )
    })
    
    # Update locality list based on selected municipality_
    observeEvent(input$municipality_name,{
        updateSelectInput(session,
                          'locality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"]),
                          # unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])[1],
                          choices=c("All",
                                    unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])),
                          selected = "All",
        )
    })
    
    observe({
        
        state_name = gsub("\\s", "+", input$state_name)
        
        data_path = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census_geo/2020/",
                          input$entity_level,
                          "/",
                          state_name,
                          "/census_geo.geojson",
                          sep = "")
        
        census_geo = st_read(data_path)
        
        if (input$entity_level == "state") {
            
            data_filtered = census_geo %>% 
                select("entity_level","state_name", input$variable)
            
            
        }
        
        if (input$entity_level == "municipality") {
            
            
            if(input$municipality_name == "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name", input$variable)
            } else {
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name) %>% 
                    select("entity_level","state_name","municipality_name", input$variable)
            }
            
        }
        
        if (input$entity_level == "locality") {
            
            if(input$municipality_name == "All" & input$locality_name == "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", input$variable)
            } else if (input$municipality_name != "All" & input$locality_name == "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", input$variable)
            } else if (input$municipality_name != "All" & input$locality_name != "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name,
                           locality_name == input$locality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", input$variable)
            } 
        }
        
        
        # table
        
        data_filtered_table = data_filtered %>% 
            as.data.frame() %>% 
            select(-geometry)
        
        output$table <- DT::renderDataTable(DT::datatable({
            
            data_filtered_table
            
        }))
        
        # output data to download
        output$downloadData <- downloadHandler(
            filename = function() {
                paste("data-", Sys.Date(), ".csv", sep="")
            },
            content = function(file) {
                write.csv(filterData(), file)
            }
        )
        
        # map
        
        # city_boundary_centroid <- st_centroid(census_geo)
        # city_boundary_centroid_lng = city_boundary_centroid$geometry[[1]][1]
        # city_boundary_centroid_lat= city_boundary_centroid$geometry[[1]][2]
        
        output$census_map <- renderLeaflet({
            leaflet(data_filtered) %>% 
                addTiles() %>% 
                # setView(lat = city_boundary_centroid_lat, lng = city_boundary_centroid_lng, zoom = 5)
                fitBounds(~as.numeric(st_bbox(census_geo)[1]),
                          ~as.numeric(st_bbox(census_geo)[2]),
                          ~as.numeric(st_bbox(census_geo)[3]),
                          ~as.numeric(st_bbox(census_geo)[4]))
        })
        
        # get selected census variable value
        census_variable_values = data_filtered %>% 
            as.data.frame() %>% 
            pull(input$variable)
        
        # define pal
        pal_census<- colorNumeric("RdYlBu", 
                                  census_variable_values,
                                  na.color = "transparent",
                                  reverse = TRUE)
        
        
        # define labels information
        labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s<br/><strong>%s:</strong> %s",
                                "geo level",geo_level, 
                                "state name", state_name,
                                "census variable", census_variable_values,
                                "state name", state_name) %>% 
            lapply(htmltools::HTML)
        
        # plot map ----
        leafletProxy(mapId = "census_map", data = data_filtered)  %>%
            clearControls() %>%
            clearShapes() %>%
            # polygons ----
            addPolygons(data = data_filtered,
                        group = "census-var",
                        fillColor = ~pal_census(census_variable_values),
                        weight = 1,
                        opacity = 1,
                        color = "grey",
                        fillOpacity = 0.9,
                        label = labels_cesus,
                        highlightOptions = highlightOptions(color = "black", weight = 2,
                                                            bringToFront = FALSE),
                        labelOptions = labelOptions(
                            style = list("font-weight" = "normal", padding = "3px 6px"),
                            textsize = "15px",
                            direction = "auto")) %>%
            # legend ----
            addLegend(pal = pal_census,
                      values = census_variable_values,
                      opacity = 0.9,
                      title = input$variable,
                      group = "census-var",
                      position = "topright",
                      labFormat = labelFormat(suffix = "")) %>%
            # Layers control ----
            addLayersControl(
                overlayGroups = c("census-var"),
                options = layersControlOptions(collapsed = FALSE)
            ) %>% 
            #hideGroup(c("Administrative boundaries")) %>% 
            addFullscreenControl()
        
    })
    
    
}

# Run the application 
shinyApp(ui = ui, server = server)
