
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)
library(leaflet)
library(leaflet.extras)
library(sf)
library(DT)




s3_path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/"

env = "dev"
selected_year = "2010"
country = "mexico"

# read census variables definition ----

census_variables_definition = read.csv(paste(s3_path, "data/", env, "/",country,"/census/",selected_year,"/census_variables_definition.csv",sep = ""))

census_variables_group = unique(census_variables_definition$variable_category)


# geographical level names ----

geo_levels_names = data.table::fread(paste(s3_path, "data/",env,"/",country,"/boundaries/",selected_year,"/geo_levels_names.csv",sep = ""),
                                     sep = ",",
                                     header = TRUE,
                                     colClasses = c('state_name'='character',
                                                    'state_code'='character',
                                                    'municipality_name'='character',
                                                    'locality_name'='character'))
geo_levels_names = as.data.frame(geo_levels_names)


geo_levels_names_col= data.table::fread(paste(s3_path, "data/",env,"/","colombia","/boundaries/geo_levels_names.csv",sep = ""),
                                        sep = ",",
                                        header = TRUE,
                                        encoding = "Latin-1",
                                        colClasses = c('municipality_name'='character',
                                                       'municipality_id'='character',
                                                       'department_name'='character',
                                                       'dept_id'='character'))


geo_levels_names_col = as.data.frame(geo_levels_names_col)

geo_levels_names_col = geo_levels_names_col %>% 
  add_row(dept_id = "All",
          department_name = "All",
          municipality_id= "All",
          municipality_name = "All")



# Define UI for application 
ui <- navbarPage("Census Dashboard",
                 # Mexico Tab ----
                 tabPanel("Mexico",
                          fluidRow(
                            # select entity level
                            column(3,
                                   selectizeInput(inputId = "entity_level",
                                                  label = "Geographical level:",
                                                  choices =  c("state","municipality","locality", "ageb", "block") ,
                                                  selected = "state",
                                                  multiple = FALSE)
                            ),
                            
                            # select group of variable
                            column(3,
                                   selectizeInput(inputId = "variable_group",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group,
                                                  selected = census_variables_group[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable
                            column(3,
                                   selectizeInput(inputId = "variable",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition$variable_name_processed_viz,
                                                  selected = census_variables_definition$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year
                            column(3,
                                   selectizeInput(inputId = "year",
                                                  label = "Year:",
                                                  choices = c("2020", "2010"),
                                                  selected = "2010",
                                                  multiple = FALSE)
                            ),
                            
                            # select state
                            column(4,
                                   selectizeInput(inputId = "state_name",
                                                  label = "State:",
                                                  choices = unique(geo_levels_names$state_name),
                                                  # choices = c("All",unique(geo_levels_names$state_name)),
                                                  selected = "All",
                                                  multiple = FALSE)
                            ),
                            
                            
                            column(4,
                                   selectizeInput(inputId = "municipality_name",
                                                  label = "Municpality:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            ),
                            column(4,
                                   selectizeInput(inputId = "locality_name",
                                                  label = "Locality:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            )
                          ),
                          
                          # Create a new row for the table.
                          column(6,
                                 DT::dataTableOutput("table"),
                                 downloadButton(outputId = "downloadData", 
                                                label = "Download data")
                          ),
                          column(6,
                                 leafletOutput("census_map", 
                                               height = 600)
                          )
                          
                 ),
                 
                 # Colombia Tab ----
                 tabPanel("Colombia",
                          fluidRow(
                            # select entity level
                            column(3,
                                   selectizeInput(inputId = "entity_level_col",
                                                  label = "Geographical level:",
                                                  choices =  c("dept","municipality") ,
                                                  selected = "dept",
                                                  multiple = FALSE)
                            ),
                            
                            # select group of variable
                            column(3,
                                   selectizeInput(inputId = "variable_group_col",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group[1],
                                                  selected = census_variables_group[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable
                            column(3,
                                   selectizeInput(inputId = "variable_col",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition$variable_name_processed_viz[1],
                                                  selected = census_variables_definition$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year
                            column(3,
                                   selectizeInput(inputId = "year_col",
                                                  label = "Year:",
                                                  choices = c("2018"),
                                                  selected = "2018",
                                                  multiple = FALSE)
                            ),
                            
                            # select department
                            column(4,
                                   selectizeInput(inputId = "department_name_col",
                                                  label = "Department:",
                                                  choices = unique(geo_levels_names_col$dept_id),
                                                  selected = "All",
                                                  multiple = FALSE)
                            ),
                            
                            
                            column(4,
                                   selectizeInput(inputId = "municipality_name_col",
                                                  label = "Municpality:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            )
                          ),
                          
                          # Create a new row for the table.
                          column(6,
                                 DT::dataTableOutput("table_col"),
                                 downloadButton(outputId = "downloadData_col", 
                                                label = "Download data")
                          ),
                          column(6,
                                 leafletOutput("census_map_col", 
                                               height = 600)
                          )
                          
                 ),
                 
                 # Brazil Tab ----
                 tabPanel("Brazil"),
                 
                 # India Tab ----
                 tabPanel("India")
)



# Define server 
server <- function(input, output, session) {
  
  # Mexico ----
  
  # Update municipality list based on selected state
  observeEvent(input$state_name,{
    updateSelectInput(session,
                      'municipality_name',
                      choices=c("All", unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])),
                      selected = "All",
    )
  })
  
  # Update locality list based on selected state
  observeEvent(input$state_name,{
    updateSelectInput(session,
                      'locality_name',
                      choices=c("All",
                                unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])),
                      selected = "All",
    )
  })
  
  # Update locality list based on selected municipality_
  observeEvent(input$municipality_name,{
    updateSelectInput(session,
                      'locality_name',
                      choices=c("All",
                                unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])),
                      selected = "All",
    )
  })
  
  # Update variable list based on selected group of variables
  observeEvent(input$variable_group,{
    updateSelectInput(session,
                      'variable',
                      choices= unique(census_variables_definition[census_variables_definition$variable_category %in% input$variable_group, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition[census_variables_definition$variable_category %in% input$variable_group, "variable_name_processed_viz"])[1],
    )
  })
  
  # Colombia ----
  
  # Update municipality list based on selected state
  observeEvent(input$department_name,{
    updateSelectInput(session,
                      'municipality_name_col',
                      choices=c("All", unique(geo_levels_names_col[geo_levels_names_col$dept_id==input$department_name, "municipality_name"])),
                      selected = "All",
    )
  })
  
  observe({
    
    input$active_tab
    ################################################
    # Mexico -----
    ################################################
    
    # get selected year ----
    selected_year = input$year
    
    # read census variables definition ----
    
    census_variables_definition = read.csv(paste(s3_path, "data/", env, "/",country,"/census/",selected_year,"/census_variables_definition.csv",sep = ""))
    census_variables_group = unique(census_variables_definition$variable_category)
    
    
    # geographical level names ----
    
    geo_levels_names = data.table::fread(paste(s3_path, "data/",env,"/",country,"/boundaries/",selected_year,"/geo_levels_names.csv",sep = ""),
                                         sep = ",",
                                         header = TRUE,
                                         colClasses = c('state_name'='character',
                                                        'state_code'='character',
                                                        'municipality_name'='character',
                                                        'locality_name'='character'))
    geo_levels_names = as.data.frame(geo_levels_names)
    
    
    
    # get selected level ----
    selected_level = input$entity_level
    
    # get selected state ----
    selected_state = input$state_name
    print(selected_state)
    
    # get selected state code ----
    state_code = geo_levels_names %>% 
      filter(state_name == selected_state) %>% 
      distinct(state_code) %>% 
      as.character()
    print(state_code)
    
    
    data_path = paste(s3_path,
                      "data/",env,"/",country,"/census_geo/",selected_year,"/",
                      selected_level,
                      "/",
                      state_code,
                      "/census_geo.geojson",
                      sep = "")
    
    census_geo = st_read(data_path)
    
    selected_variable_viz = input$variable
    
    selected_variable = census_variables_definition %>% 
      filter(variable_name_processed_viz %in% selected_variable_viz) %>% 
      pull(variable_name_processed)
    
    if (input$entity_level == "state") {
      
      data_filtered = census_geo %>% 
        select("entity_level","state_name", selected_variable)
      
      geo_name = data_filtered$state_name
      
      
    }
    
    if (input$entity_level == "municipality") {
      
      
      if(input$municipality_name == "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("entity_level","state_name","municipality_name", selected_variable)
        geo_name = data_filtered$municipality_name
      } else {
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("entity_level","state_name","municipality_name", selected_variable)
        geo_name = data_filtered$municipality_name
      }
      
    }
    
    if (input$entity_level == "locality") {
      
      if(input$municipality_name == "All" & input$locality_name == "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name", selected_variable)
        geo_name = data_filtered$locality_name
      } else if (input$municipality_name != "All" & input$locality_name == "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name", selected_variable)
        geo_name = data_filtered$locality_name
      } else if (input$municipality_name != "All" & input$locality_name != "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name,
                 locality_name == input$locality_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name", selected_variable)
        geo_name = data_filtered$locality_name
      } 
    }
    
    if (input$entity_level == "ageb") {
      
      if(input$municipality_name == "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name","ageb_id", selected_variable)
        
        geo_name = data_filtered$ageb_id
        
      } else if (input$municipality_name != "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name","ageb_id", selected_variable)
        
        geo_name = data_filtered$ageb_id
        
      } else if (input$municipality_name != "All" & input$locality_name != "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name,
                 locality_name == input$locality_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name","ageb_id", selected_variable)
        
        geo_name = data_filtered$ageb_id
      } 
    }
    
    if (input$entity_level == "block") {
      
      if(input$municipality_name == "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name", "block_id",selected_variable) 
        
        geo_name = data_filtered$block_id
        
      } else if (input$municipality_name != "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name","block_id", selected_variable)
        
        geo_name = data_filtered$block_id
        
      } else if (input$municipality_name != "All" & input$locality_name != "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name,
                 locality_name == input$locality_name) %>% 
          select("entity_level","state_name","municipality_name","locality_name","block_id",  selected_variable)
        
        geo_name = data_filtered$block_id
      } 
    }
    
    
    # table -----
    
    data_filtered_table = data_filtered %>% 
      as.data.frame() %>% 
      select(-geometry)
    
    
    output$table <- DT::renderDataTable(DT::datatable(
      data_filtered_table,
      filter = 'top',
      options = list(paging = TRUE,    
                     pageLength = 10,  
                     scrollX = TRUE,   
                     scrollY = TRUE,   
                     autoWidth = TRUE, 
                     server = FALSE)
    ))
    
    # output data to download ----
    output$downloadData <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table, file)
      }
    )
    
    # map ----
    
    
    # get selected census variable value
    
    selected_variable_map = selected_variable[1]
    
    census_variable_values = data_filtered %>% 
      as.data.frame() %>% 
      pull(selected_variable_map)
    
    
    # define pal
    pal_census<- colorNumeric("RdYlBu", 
                              census_variable_values,
                              na.color = "transparent",
                              reverse = TRUE)
    
    
    # define labels information
    labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s<br/><strong>%s:</strong> %s",
                            "State",input$state_name, 
                            "Census variable", selected_variable_map,
                            "Value", census_variable_values,
                            "Name", geo_name) %>% 
      lapply(htmltools::HTML)
    
    # plot map ----
    
    m = leaflet(data_filtered) %>% 
      addTiles() %>% 
      fitBounds(~as.numeric(st_bbox(census_geo)[1]),
                ~as.numeric(st_bbox(census_geo)[2]),
                ~as.numeric(st_bbox(census_geo)[3]),
                ~as.numeric(st_bbox(census_geo)[4])) %>% 
      addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
      # polygons ----
    addPolygons(data = data_filtered,
                group = "census-var",
                fillColor = ~pal_census(census_variable_values),
                weight = 0.1,
                opacity = 1,
                color = "grey",
                fillOpacity = 0.9,
                label = labels_cesus,
                highlightOptions = highlightOptions(color = "black", weight = 2,
                                                    bringToFront = FALSE),
                labelOptions = labelOptions(
                  style = list("font-weight" = "normal", padding = "3px 6px"),
                  textsize = "15px",
                  direction = "auto")) %>%
      # legend ----
    addLegend(pal = pal_census,
              values = census_variable_values,
              opacity = 0.9,
              # title = input$variable,
              title = selected_variable_map,
              group = "census-var",
              position = "topright",
              labFormat = labelFormat(suffix = "")) %>%
      # Layers control ----
    addLayersControl(
      overlayGroups = c("census-var"),
      baseGroups = c("OSM","Toner Lite", "CartoDB"),
      options = layersControlOptions(collapsed = FALSE)
    ) %>% 
      #hideGroup(c("Administrative boundaries")) %>% 
      addFullscreenControl()
      
    # render map
    output$census_map <- renderLeaflet({
      m
      
    })
    
    ################################################
    # Colombia -----
    ################################################
    
    # get selected year ----
    selected_year_col = input$year_col


    # get selected level ----
    selected_level_col = input$entity_level_col

    # get selected state ----
    selected_department = input$department_name_col
    print(selected_department)

    # get selected department code ----
    department_code = geo_levels_names_col %>%
      filter(dept_id == selected_department) %>%
      distinct(dept_id) %>%
      as.character()
    print(department_code)


    data_path_col = paste(s3_path,
                      "data/",env,"/","colombia","/census_geo/",
                      selected_level_col,
                      "/",
                      department_code,
                      "/census_geo.geojson",
                      sep = "")

    census_geo_col = st_read(data_path_col)

    selected_variable_viz_col = input$variable_col

    selected_variable_col = census_variables_definition %>%
      filter(variable_name_processed_viz %in% selected_variable_viz_col) %>%
      pull(variable_name_processed)

    # filter data state ----

    data_filtered_col = census_geo_col %>%
      select("entity_level","department_name", selected_variable_col)
    
    print(head(data_filtered_col))

    geo_name_col = data_filtered_col$department_name


    # table ----

    data_filtered_table_col = data_filtered_col %>%
      as.data.frame() %>%
      select(-geometry)

    output$table_col <- DT::renderDataTable(DT::datatable(
      data_filtered_table_col,
      filter = 'top',
      options = list(paging = TRUE,
                     pageLength = 10,
                     scrollX = TRUE,
                     scrollY = TRUE,
                     autoWidth = TRUE,
                     server = FALSE)
    ))

    # output data to download ----
    output$downloadData_col <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table_col, file)
      }
    )

    # map ----
    
    
    # get selected census variable value
    
    selected_variable_map_col = selected_variable_col[1]
    
    census_variable_values_col = data_filtered_col %>% 
      as.data.frame() %>% 
      pull(selected_variable_map_col)
    
    
    # define pal
    pal_census_col<- colorNumeric("RdYlBu", 
                              census_variable_values_col,
                              na.color = "transparent",
                              reverse = TRUE)
    
    
    # define labels information
    # labels_cesus_col <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s<br/><strong>%s:</strong> %s",
    #                         "department",input$department_name_col, 
    #                         "Census variable", selected_variable_map_col,
    #                         "Value", census_variable_values_col,
    #                         "Name", geo_name_col) %>% 
    #   lapply(htmltools::HTML)
    
    # plot map ----
    
    m_col = leaflet(data_filtered_col) %>% 
      addTiles() %>% 
      fitBounds(~as.numeric(st_bbox(census_geo_col)[1]),
                ~as.numeric(st_bbox(census_geo_col)[2]),
                ~as.numeric(st_bbox(census_geo_col)[3]),
                ~as.numeric(st_bbox(census_geo_col)[4])) %>% 
      addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
      # polygons ----
    addPolygons(data = data_filtered_col,
                group = "census-var",
                fillColor = ~pal_census_col(census_variable_values_col),
                weight = 0.1,
                opacity = 1,
                color = "grey",
                fillOpacity = 0.9,
                # label = labels_cesus_col,
                highlightOptions = highlightOptions(color = "black", weight = 2,
                                                    bringToFront = FALSE),
                labelOptions = labelOptions(
                  style = list("font-weight" = "normal", padding = "3px 6px"),
                  textsize = "15px",
                  direction = "auto")) %>%
      # legend ----
    addLegend(pal = pal_census_col,
              values = census_variable_values_col,
              opacity = 0.9,
              # title = input$variable,
              title = selected_variable_map_col,
              group = "census-var",
              position = "topright",
              labFormat = labelFormat(suffix = "")) %>%
      # Layers control ----
    addLayersControl(
      overlayGroups = c("census-var"),
      baseGroups = c("OSM","Toner Lite", "CartoDB"),
      options = layersControlOptions(collapsed = FALSE)
    ) %>% 
      #hideGroup(c("Administrative boundaries")) %>% 
      addFullscreenControl()
    
    # render map
    output$census_map_col <- renderLeaflet({
      m_col
    })

   
    
  })
  
  
}

# Run the application 
shinyApp(ui = ui, server = server)
