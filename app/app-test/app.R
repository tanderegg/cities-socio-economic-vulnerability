
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)


geo_levels = c("state","mun", "loc", "ageb") 

fixed_variables = c("entity_level","state_name","municipality_name","locality_name")


census_variables_df = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/mexico_census_variables_df.csv")
geo_levels_names = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/geo_levels_names.csv")

geo_levels_names[5243, "state_name"] = "Aguascalientes"
geo_levels_names[5243, "municipality_name"] = "All"
geo_levels_names[5243, "locality_name"] = "All"
    
# Define UI for application 
ui <- navbarPage("Census Dashboard",
                 tabPanel("Mexico",
                          fluidRow(
                              # select entity level
                              column(4,
                                     selectizeInput(inputId = "entity_level",
                                                    label = "Geographical level:",
                                                    choices = geo_levels,
                                                    selected = geo_levels[1],
                                                    multiple = FALSE)
                              ),
                              
                              # select variable
                              column(4,
                                     selectizeInput(inputId = "variable",
                                                    label = "Census variable:",
                                                    choices = census_variables_df$census_variables,
                                                    selected = census_variables_df$census_variables[1],
                                                    multiple = FALSE)
                              ),
                              
                              # select year
                              column(4,
                                     selectizeInput(inputId = "year",
                                                    label = "Year:",
                                                    choices = 2020,
                                                    selected = 2020,
                                                    multiple = FALSE)
                              ),
                              
                              # select state
                              column(4,
                                     selectizeInput(inputId = "state_name",
                                                    label = "State:",
                                                    choices = unique(geo_levels_names$state_name),
                                                    selected = unique(geo_levels_names$state_name)[1],
                                                    multiple = FALSE)
                              ),
                              
                              
                              column(4,
                                     selectizeInput(inputId = "municipality_name",
                                                    label = "Municpality:",
                                                    choices =  NULL,
                                                    multiple = FALSE)
                              ),
                              column(4,
                                     selectizeInput(inputId = "locality_name",
                                                    label = "Locality:",
                                                    choices =  NULL,
                                                    multiple = FALSE)
                              )
                          ),
                          # Create a new row for the table.
                          DT::dataTableOutput("table"),
                          
                          downloadButton(outputId = "downloadData", 
                                         label = "Download data")
                 ),
                 tabPanel("Brazil"),
                 tabPanel("Columbia"),
                 tabPanel("India")
)



# Define server 
server <- function(input, output, session) {
    
    # Update municipality list based on selected state
    observeEvent(input$state_name,{
        updateSelectInput(session,
                          'municipality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"]),
                          choices=c("All", unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])),
                          selected = "All")
    })
    
    # Update municipality list based on selected state
    observeEvent(input$state_name,{
        updateSelectInput(session,
                          'locality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"]),
                          choices=c("All", 
                                    unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])),
                          selected = "All")
    })

    # Update municipality list based on selected state
    observeEvent(input$municipality_name,{
        updateSelectInput(session,
                          'locality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"]),
                          choices=c("All", 
                                    unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])),
                          selected = "All")
    })
    

    
    observe({
        
        data_path = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/census_mexico_", 
                          input$entity_level,
                          "_abs_w.csv", 
                          sep = "")
        print(data_path)
        
        # read data
        # data = fread(data_path,
        #              sep = ",",
        #              encoding = "UTF-8",
        #              header = TRUE)
        
        data = read.csv(data_path,
                        encoding = "UTF-8",
                        check.names=FALSE)
        
        data = as.data.frame(data)
        
        data_filtered = data %>%
            as.data.frame()
        
    })
    
    # filter data
    
    filterData1 <- reactive({

        
        
        if (input$entity_level == "state") {
            
            data_filtered = data_filtered %>% 
                filter(state_name == input$state_name) %>% 
                select("entity_level","state_name",input$variable)
            
        }

        if (input$entity_level == "mun") {
            # data_filtered <- data_filtered[data_filtered$state_name == input$state_name & data_filtered$municipality_name %in% input$municipality_name,]
            if(input$municipality_name == "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name", input$variable)
            } else {
                data_filtered = data_filtered %>% 
                       filter(state_name == input$state_name,
                              municipality_name == input$municipality_name) %>% 
                       select("entity_level","state_name","municipality_name", input$variable)
            }
            
        }
        
        if (input$entity_level == "loc") {
            
            if(input$municipality_name == "All" & input$locality_name == "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", input$variable)
            } else if (input$municipality_name != "All" & input$locality_name == "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", input$variable)
            } else if (input$municipality_name != "All" & input$locality_name != "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name,
                           locality_name == input$locality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", input$variable)
            } 
        }
        
        if (input$entity_level == "ageb") {
            
            if(input$municipality_name == "All" & input$locality_name == "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name","ageb_id", input$variable)
            } else if (input$municipality_name != "All" & input$locality_name == "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name","ageb_id", input$variable)
            } else if (input$municipality_name != "All" & input$locality_name != "All"){
                data_filtered = data_filtered %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name,
                           locality_name == input$locality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name","ageb_id", input$variable)
            } 
        }
        
        
        data_filtered
        

    })
    
    output$table <- DT::renderDataTable(DT::datatable({
        
        filterData1()
        
    }))
    
    # output data to download
    output$downloadData <- downloadHandler(
        filename = function() {
            paste("data-", Sys.Date(), ".csv", sep="")
        },
        content = function(file) {
            write.csv(data_filtered, file)
        }
    )

    
}

# Run the application 
shinyApp(ui = ui, server = server)
