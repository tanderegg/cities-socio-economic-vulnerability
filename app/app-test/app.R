
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)
library(leaflet)
library(leaflet.extras)
library(sf)


geo_levels = c("state","mun", "loc", "ageb") 

fixed_variables = c("entity_level","state_name","municipality_name","locality_name")


census_variables_df = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/mexico_census_variables_df.csv")
geo_levels_names = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/geo_levels_names.csv")

# read census variables definition
census_variables_definition = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census/census_variables_definition.csv",
                                       fileEncoding="UTF-8-BOM")

census_variables_group = unique(census_variables_definition$variable_category)

geo_levels_names[5243, "state_name"] = "Aguascalientes"
geo_levels_names[5243, "municipality_name"] = "All"
geo_levels_names[5243, "locality_name"] = "All"

# Define UI for application 
ui <- navbarPage("Census Dashboard",
                 # Mexico Tab ----
                 tabPanel("Mexico",
                          fluidRow(
                              # select entity level
                              column(3,
                                     selectizeInput(inputId = "entity_level",
                                                    label = "Geographical level:",
                                                    choices =  c("state","municipality","locality") ,
                                                    selected = "state",
                                                    multiple = FALSE)
                              ),
                              
                              # select group of variable
                              column(3,
                                     selectizeInput(inputId = "variable_group",
                                                    label = "Census variable theme:",
                                                    choices = census_variables_group,
                                                    selected = census_variables_group[1],
                                                    multiple = TRUE)
                              ),
                              
                              # select variable
                              column(3,
                                     selectizeInput(inputId = "variable",
                                                    label = "Census variable:",
                                                    choices = census_variables_definition$variable_name_processed_viz,
                                                    selected = census_variables_definition$variable_name_processed_viz[1],
                                                    multiple = TRUE)
                              ),
                              
                              # select year
                              column(3,
                                     selectizeInput(inputId = "year",
                                                    label = "Year:",
                                                    choices = 2020,
                                                    selected = 2020,
                                                    multiple = FALSE)
                              ),
                              
                              # select state
                              column(4,
                                     selectizeInput(inputId = "state_name",
                                                    label = "State:",
                                                    choices = c("All",unique(geo_levels_names$state_name)),
                                                    # selected = unique(geo_levels_names$state_name)[1],
                                                    selected = "All",
                                                    multiple = FALSE)
                              ),
                              
                              
                              column(4,
                                     selectizeInput(inputId = "municipality_name",
                                                    label = "Municpality:",
                                                    choices =  NULL,
                                                    multiple = FALSE)
                              ),
                              column(4,
                                     selectizeInput(inputId = "locality_name",
                                                    label = "Locality:",
                                                    choices =  NULL,
                                                    multiple = FALSE)
                              )
                          ),
                          # Create a new row for the table.
                          # DT::dataTableOutput("table"),
                          column(6,
                                 DT::dataTableOutput("table"),
                                 downloadButton(outputId = "downloadData", 
                                                label = "Download data")
                          ),
                          column(6,
                                 leafletOutput("census_map", 
                                               height = 600)
                          )
                          
                 ),
                 # Brazil Tab ----
                 tabPanel("Brazil"),
                 # Colombia Tab ----
                 tabPanel("Colombia"),
                 # India Tab ----
                 tabPanel("India")
)



# Define server 
server <- function(input, output, session) {
    
    # Update municipality list based on selected state
    observeEvent(input$state_name,{
        updateSelectInput(session,
                          'municipality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"]),
                          # unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])[1],
                          choices=c("All", unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])),
                          selected = "All",
        )
    })
    
    # Update locality list based on selected state
    observeEvent(input$state_name,{
        updateSelectInput(session,
                          'locality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"]),
                          # selected = unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])[1],
                          choices=c("All",
                                    unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])),
                          selected = "All",
        )
    })
    
    # Update locality list based on selected municipality_
    observeEvent(input$municipality_name,{
        updateSelectInput(session,
                          'locality_name',
                          # choices=unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"]),
                          # unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])[1],
                          choices=c("All",
                                    unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])),
                          selected = "All",
        )
    })
    
    # Update variable list based on selected group of variables
    observeEvent(input$variable_group,{
        updateSelectInput(session,
                          'variable',
                          choices= unique(census_variables_definition[census_variables_definition$variable_category %in% input$variable_group, "variable_name_processed_viz"]),
                          selected = unique(census_variables_definition[census_variables_definition$variable_category %in% input$variable_group, "variable_name_processed_viz"])[1],
        )
    })
    
    observe({
        
        state_name = gsub("\\s", "+", input$state_name)
        print(state_name)
        
        data_path = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census_geo/2020/",
                          input$entity_level,
                          "/",
                          state_name,
                          "/census_geo.geojson",
                          sep = "")
        print(data_path)
        
        census_geo = st_read(data_path)
        
        selected_variable_viz = input$variable
        selected_variable = census_variables_definition %>% 
            filter(variable_name_processed_viz %in% selected_variable_viz) %>% 
            pull(variable_name_processed)
        
        if (input$entity_level == "state") {
            
            data_filtered = census_geo %>% 
                select("entity_level","state_name", selected_variable)
            
            geo_name = data_filtered$state_name
            
            
        }
        
        if (input$entity_level == "municipality") {
            
            
            if(input$municipality_name == "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name", selected_variable)
                geo_name = data_filtered$municipality_name
            } else {
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name) %>% 
                    select("entity_level","state_name","municipality_name", selected_variable)
                geo_name = data_filtered$municipality_name
            }
            
        }
        
        if (input$entity_level == "locality") {
            
            if(input$municipality_name == "All" & input$locality_name == "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", selected_variable)
                geo_name = data_filtered$locality_name
            } else if (input$municipality_name != "All" & input$locality_name == "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", selected_variable)
                geo_name = data_filtered$locality_name
            } else if (input$municipality_name != "All" & input$locality_name != "All"){
                data_filtered = census_geo %>% 
                    filter(state_name == input$state_name,
                           municipality_name == input$municipality_name,
                           locality_name == input$locality_name) %>% 
                    select("entity_level","state_name","municipality_name","locality_name", selected_variable)
                geo_name = data_filtered$locality_name
            } 
        }
        
        
        # table
        
        data_filtered_table = data_filtered %>% 
            as.data.frame() %>% 
            select(-geometry)
        
        
        output$table <- DT::renderDataTable(DT::datatable(
            data_filtered_table,
            filter = 'top',
            options = list(paging = TRUE,    
                           pageLength = 10,  
                           scrollX = TRUE,   
                           scrollY = TRUE,   
                           autoWidth = TRUE, 
                           server = FALSE)
            ))
        
        # output data to download ----
        output$downloadData <- downloadHandler(
            filename = function() {
                paste("data-", Sys.Date(), ".csv", sep="")
            },
            content = function(file) {
                write.csv(data_filtered_table, file)
            }
        )
        
        # map
        
        # city_boundary_centroid <- st_centroid(census_geo)
        # city_boundary_centroid_lng = city_boundary_centroid$geometry[[1]][1]
        # city_boundary_centroid_lat= city_boundary_centroid$geometry[[1]][2]
        
        output$census_map <- renderLeaflet({
            leaflet(data_filtered) %>% 
                addTiles() %>% 
                # setView(lat = city_boundary_centroid_lat, lng = city_boundary_centroid_lng, zoom = 5)
                fitBounds(~as.numeric(st_bbox(census_geo)[1]),
                          ~as.numeric(st_bbox(census_geo)[2]),
                          ~as.numeric(st_bbox(census_geo)[3]),
                          ~as.numeric(st_bbox(census_geo)[4]))
        })
        
        # get selected census variable value
        
        selected_variable_map = selected_variable[1]
        
        census_variable_values = data_filtered %>% 
            as.data.frame() %>% 
            pull(selected_variable_map)

        
        # define pal
        pal_census<- colorNumeric("RdYlBu", 
                                  census_variable_values,
                                  na.color = "transparent",
                                  reverse = TRUE)
        
        
        # define labels information
        labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s<br/><strong>%s:</strong> %s",
                                "State",input$state_name, 
                                "Census variable", selected_variable_map,
                                "Value", census_variable_values,
                                "Name", geo_name) %>% 
            lapply(htmltools::HTML)
        
        # plot map ----
        leafletProxy(mapId = "census_map", data = data_filtered)  %>%
            clearControls() %>%
            clearShapes() %>%
            # polygons ----
        addPolygons(data = data_filtered,
                    group = "census-var",
                    fillColor = ~pal_census(census_variable_values),
                    weight = 1,
                    opacity = 1,
                    color = "grey",
                    fillOpacity = 0.9,
                    label = labels_cesus,
                    highlightOptions = highlightOptions(color = "black", weight = 2,
                                                        bringToFront = FALSE),
                    labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 6px"),
                        textsize = "15px",
                        direction = "auto")) %>%
            # legend ----
        addLegend(pal = pal_census,
                  values = census_variable_values,
                  opacity = 0.9,
                  # title = input$variable,
                  title = selected_variable_map,
                  group = "census-var",
                  position = "topright",
                  labFormat = labelFormat(suffix = "")) %>%
            # Layers control ----
        addLayersControl(
            overlayGroups = c("census-var"),
            options = layersControlOptions(collapsed = FALSE)
        ) %>% 
            #hideGroup(c("Administrative boundaries")) %>% 
            addFullscreenControl()
        
    })
    
    
}

# Run the application 
shinyApp(ui = ui, server = server)
