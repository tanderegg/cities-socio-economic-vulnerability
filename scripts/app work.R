library(rgdal)
geo_levels_names = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/geo_levels_names.csv")
census_variables_df = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mapped/mexico_census_variables_df.csv")
census_variables_definition = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census/census_variables_definition.csv",
                                       fileEncoding="UTF-8-BOM")

census_variables_definition[1, ]

census_variables = census_variables_definition$variable_name_processed

selected_variable = census_variables_definition$variable_name_processed_viz[1]
selected_variable_data = census_variables_definition %>% 
  filter(variable_name_processed_viz == selected_variable) %>% 
  pull(variable_name_processed)


geo_level = "state" # "state" #municipality  locality
state_name = "All" # "Aguascalientes" All Durango
selected_variable = census_variables[10] #"d_dwg"


data_path = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census_geo/2020/",
                  geo_level,
                  "/",
                  state_name,
                  "/census_geo.geojson",
                  sep = "")

census_geo = st_read(data_path)


# state level filter

data_filtered = census_geo %>% 
  select("entity_level","state_name", selected_variable)

# mun
data_filtered = census_geo %>% 
  # filter(state_name == state_name) %>% 
  select("entity_level","state_name","municipality_name", selected_variable)

data_filtered[1, ]

# locality
data_filtered = census_geo %>% 
  #as.data.frame() %>% 
  filter(state_name == state_name) %>% 
  select("entity_level","state_name","municipality_name","locality_name", selected_variable)

data_filtered[1, ]


######## map ----

data_filtered = data_filtered[2,]

census_variable_values = data_filtered %>% 
  as.data.frame() %>% 
  pull(selected_variable)


# define pal
pal_census<- colorNumeric("RdYlBu", 
                          census_variable_values,
                         na.color = "transparent",
                         reverse = TRUE)


# define labels information
labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s<br/><strong>%s:</strong> %s",
                          "geo level",geo_level, 
                          "state name", state_name,
                          "census variable", census_variable_values,
                        "state name", state_name) %>% 
  lapply(htmltools::HTML)


# map



map = leaflet(data_filtered, height = 700, width = "100%")  %>%
  addTiles() %>%
  addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
  # Census variable
  addPolygons(data = data_filtered,
              group = "census-var",
              fillColor = ~pal_census(census_variable_values),
              weight = 1,
              opacity = 1,
              color = "grey",
              fillOpacity = 0.9,
              label = labels_cesus,
              highlightOptions = highlightOptions(color = "black", weight = 2,
                                                  bringToFront = FALSE),
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 6px"),
                textsize = "15px",
                direction = "auto")) %>%
  addLegend(pal = pal_census,
            values = census_variable_values,
            opacity = 0.9,
            title = selected_variable,
            group = "census-var",
            position = "topright",
            labFormat = labelFormat(suffix = "")) %>%
  # Layers control
  addLayersControl(
    overlayGroups = c("census-var"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  #hideGroup(c("Administrative boundaries")) %>% 
  addFullscreenControl()

map
