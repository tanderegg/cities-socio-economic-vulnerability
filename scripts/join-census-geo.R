################################################################################################
# This script is to join census data with boundaries at diffrent geographical levels
# input: 
#     - census data stored as csv files in aws s3 bucket
#     - boundaries data stored as geojson files in aws s3 bucket
# output: 
#     - census_geo data stored as geojson files in aws s3 bucket
################################################################################################


library(aws.s3)
library(sf)
library(data.table)
library(tidyverse)

#################################### 
################## State level -----
####################################

# read census ----


census_state = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/census/2020/census_mexico_state_2020.csv",
                               sep = ",",
                               encoding = "UTF-8",
                               header = TRUE,
                               colClasses = c('state_id'='character'))

# read shapes ----
geo_state <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_01_state.geojson")


# merge
census_state_geo = geo_state %>% 
  left_join(census_state,
            by = c("CVEGEO" = "state_id"),
            keep = TRUE)

# get state codes list ----
state_list = unique(census_state_geo$state_name)
state_codes = unique(census_state_geo$CVEGEO)

# create directory ----
dir.create("./data/dev/mexico/census_geo/state")

# create geojson files for each state  ----

for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  print(i)
  print(state_i)
  
  # filter state
  census_state_geo_state = census_state_geo %>% 
    filter(state_name == state_i)
  
  # create dir
  dir_path = paste("./data/dev/mexico/census_geo/state/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_state_geo_2020.geojson",
                    sep = "/")
  st_write(census_state_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico/census_geo/2020/state/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

# create census geo with all states ----

# simplify geom
census_state_geo_simpl <- st_simplify(census_state_geo, 
                                      preserveTopology = TRUE, 
                                      dTolerance = 50)

# create dir
dir_path = paste("./data/dev/mexico/census_geo/state/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_state_geo_2020.geojson",
                  sep = "/")
st_write(census_state_geo_simpl,
         file_path,
         delete_dsn = TRUE)

# upload to s3
object_path = paste("data/dev/mexico/census_geo/2020/state/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

#################################### 
######### Municipality level -----
#################################### 

# read census
census_municipality = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/census/2020/census_mexico_municipality_2020.csv",
                                        sep = ",",
                                        encoding = "UTF-8",
                                        header = TRUE,
                                        colClasses = c('state_id'='character',
                                                       'municipality_id'='character'))
# Add mun id
census_municipality = census_municipality %>% 
  unite(municipality_id,
        c(state_id,municipality_id), 
        sep = "")


# read shapes
geo_municipality <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_02_municipality.geojson")

# merge
census_municipality_geo = geo_municipality %>% 
  left_join(census_municipality,
            #by = c("NOMGEO" = "municipality_name"),
            by = c("CVEGEO" = "municipality_id"),
            keep = TRUE) %>%
  # keep mun with census data
  drop_na(municipality_name) 




# create directory ----
dir.create("./data/dev/mexico/census_geo/municipality")

# create geojson files for each state  ----

for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  print(i)
  print(state_i)
  
  # filter state
  census_municipality_geo_state = census_municipality_geo %>% 
    filter(state_name == state_i)
  
  # create dir
  dir_path = paste("./data/dev/mexico/census_geo/municipality/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_municipality_geo_2020.geojson",
                    sep = "/")
  st_write(census_municipality_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico/census_geo/2020/municipality/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}


# create geojson with all states ----

census_municipality_geo_all = census_municipality_geo %>% 
  mutate(state_name = "All")

# simplify geom
census_municipality_geo_all_simpl <- st_simplify(census_municipality_geo_all, 
                                                 preserveTopology = TRUE, 
                                                 dTolerance = 100)

# create dir
dir_path = paste("./data/dev/mexico/census_geo/municipality/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_municipality_geo_2020.geojson",
                  sep = "/")
st_write(census_municipality_geo_all_simpl,
         file_path,
         delete_dsn = TRUE)
# upload to s3
object_path = paste("data/dev/mexico/census_geo/2020/municipality/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


#################################### 
######### Locality level -----
#################################### 

# read census
census_locality = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/census/2020/census_mexico_locality_2020.csv",
                                        sep = ",",
                                        encoding = "UTF-8",
                                        header = TRUE,
                                        colClasses = c('state_id'='character',
                                                       'municipality_id'='character',
                                                       'locality_id'='character'))
# Add mun id
census_locality = census_locality %>% 
  unite(locality_id,
        c(state_id,municipality_id,locality_id), 
        sep = "")


# read shapes
geo_locality <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_03_locality_simplified.geojson")

# merge
census_locality_geo = geo_locality %>% 
  left_join(census_locality,
            #by = c("NOMGEO" = "locality_name"),
            by = c("CVEGEO" = "locality_id"),
            keep = TRUE) %>%
  # keep locality with census data
  drop_na(locality_name) 

# create directory ----
dir.create("./data/dev/mexico/census_geo/locality")

# create geojson files for each state  ----

for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  print(i)
  print(state_i)
  
  # filter state
  census_locality_geo_state = census_locality_geo %>% 
    filter(state_name == state_i)
  
  # create dir
  dir_path = paste("./data/dev/mexico/census_geo/locality/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_locality_geo_2020.geojson",
                    sep = "/")
  st_write(census_locality_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico/census_geo/2020/locality/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}


# create geojson with all states ----

census_locality_geo_all = census_locality_geo %>% 
  mutate(state_name = "All")

# create dir
dir_path = paste("./data/dev/mexico/census_geo/locality/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store localy
file_path = paste(dir_path,
                  "census_locality_geo_2020.geojson",
                  sep = "/")
st_write(census_locality_geo_all,
         file_path,
         delete_dsn = TRUE)
# upload to s3
object_path = paste("data/dev/mexico/census_geo/2020/locality/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

#################################### 
######### ageb level -----
#################################### 


# read census
census_ageb = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/census/2020/census_mexico_ageb_2020.csv",
                                    sep = ",",
                                    encoding = "UTF-8",
                                    header = TRUE,
                                    colClasses = c('state_id'='character',
                                                   'municipality_id'='character',
                                                   'locality_id'='character',
                                                   'ageb_id'='character'))
# Add ageb id
census_ageb = census_ageb %>% 
  unite(ageb_id,
        c(state_id,municipality_id,locality_id,ageb_id), 
        sep = "")


# read shapes
geo_ageb<- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_04_geo_ageb_simplified.geojson")

# merge
census_ageb_geo = geo_ageb %>% 
  left_join(census_ageb,
            by = c("CVEGEO" = "ageb_id"),
            keep = TRUE) %>%
  # keep ageb with census data
  drop_na(state_name) 



# create directory ----
dir.create("./data/dev/mexico/census_geo/ageb")

# create geojson files for each state  ----

for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  print(i)
  print(state_i)
  
  # filter state
  census_ageb_geo_state = census_ageb_geo %>% 
    filter(state_name == state_i)
  
  # create dir
  dir_path = paste("./data/dev/mexico/census_geo/ageb/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_ageb_geo_2020.geojson",
                    sep = "/")
  st_write(census_ageb_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico/census_geo/2020/ageb/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}


# create geojson with all states ----

census_ageb_geo_all = census_ageb_geo %>% 
  mutate(state_name = "All")

# create dir
dir_path = paste("./data/dev/mexico/census_geo/ageb/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store local
file_path = paste(dir_path,
                  "census_ageb_geo_2020.geojson",
                  sep = "/")
st_write(census_ageb_geo_all,
         file_path,
         delete_dsn = TRUE)
# upload to s3
object_path = paste("data/dev/mexico/census_geo/2020/ageb/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


#################################### 
######### block level -----
#################################### 

for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  print(i)
  print(state_i)


  # read census
  census_block_state = data.table::fread(paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/census/block/mexico_census_2020_block_",
                                               state_i_code,
                                               ".csv",
                                               sep = ""),
                                         sep = ",",
                                         encoding = "UTF-8",
                                         header = TRUE,
                                         colClasses = c('state_id'='character',
                                                        'municipality_id'='character',
                                                        'locality_id'='character',
                                                        'ageb_id'='character',
                                                        'block_id'='character'))

  # Add block_id
  census_block_state = census_block_state %>% 
    mutate(block_id = str_pad(block_id, 3, side = 'left', pad = '0')) %>% 
    unite(block_id,
          c(state_id,municipality_id,locality_id,ageb_id,block_id), 
          sep = "")



  # read shapes
  geo_block_state <- st_read(paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/05_block/",
                                   state_i_code,
                                   ".geojson",
                                   sep = "")
                             )

  # merge
  census_block_geo_state = geo_block_state %>% 
    left_join(census_block_state,
              by = c("CVEGEO" = "block_id"),
              keep = TRUE) %>%
    # keep blocks with census data
    drop_na(state_name) 

  # create dir
  dir_path = paste("./data/dev/mexico/census_geo/block/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path,recursive = TRUE)

  # store locally
  file_path = paste(dir_path,
                    "census_block_geo_2020.geojson",
                    sep = "/")
  st_write(census_block_geo_state,
           file_path,
           delete_dsn = TRUE)

  # upload to s3
  object_path = paste("data/dev/mexico/census_geo/2020/block/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
}
