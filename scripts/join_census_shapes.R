library(aws.s3)
library(sf)



################## State level

# read census
census_state <- s3read_using(FUN = data.table::fread, 
                        object = "s3://cities-socio-economic-vulnerability/mexico/census/census_mexico_state_2020.csv")

census_state = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census/census_mexico_state_2020.csv",
                         sep = ",",
                         encoding = "UTF-8",
                         header = TRUE)

# read shapes
geo_state <- s3read_using(FUN = sf::st_read, 
                             object = "s3://cities-socio-economic-vulnerability/mexico/boundaries/01_state.geojson")

# merge
census_state_geo = geo_state %>% 
  left_join(census_state,
            by = c("NOMGEO" = "state_name"),
            keep = TRUE)

state_list = unique(census_municipality_geo$state_name)

# create directory
dir.create("./data/mexico/census_geo/state")

for(i in 1:length(state_list)){
  
  state_i = state_list[i]
  print(i)
  print(length(state_list))
  # filter state
  census_state_geo_state = census_state_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./data/mexico/census_geo/state/",
                   state_i,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_state_geo_2020.geojson",
                    sep = "/")
  st_write(census_state_geo_state,
           file_path,
           delete_dsn = TRUE) 
  # upload to s3
  object_path = paste("mexico/census_geo/2020/state/",
                      state_i,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

# create geojson with all states

object.size(census_state_geo)/1000000

census_state_geo_simpl <- st_simplify(census_state_geo, 
                             preserveTopology = TRUE, 
                             dTolerance = 50)

unique(st_geometry_type(census_state_geo_simpl, by_geometry = TRUE))

object.size(census_state_geo_simpl)/1000000

# create dir
dir_path = paste("./data/mexico/census_geo/state/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_state_geo_2020.geojson",
                  sep = "/")
st_write(census_state_geo_simpl,
         file_path,
         delete_dsn = TRUE)
# upload to s3
object_path = paste("mexico/census_geo/2020/state/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


################## Municipality level

# read census
# census_municipality <- s3read_using(FUN = data.table::fread, 
#                              object = "s3://cities-socio-economic-vulnerability/mexico/census/census_mexico_municipality_2020.csv")

object.size(census_municipality)/1000000

data = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census/census_mexico_municipality_2020.csv",
                         sep = ",",
                         encoding = "UTF-8",
                         header = TRUE)

# read shapes
geo_municipality <- s3read_using(FUN = sf::st_read, 
                          object = "s3://cities-socio-economic-vulnerability/mexico/boundaries/02_mun.geojson")

object.size(geo_municipality)/1000000

# merge
census_municipality_geo = geo_municipality %>% 
  left_join(data,
            by = c("NOMGEO" = "municipality_name"),
            keep = TRUE) %>% 
  drop_na(municipality_name) %>% 
  distinct(NOMGEO,municipality_name, .keep_all= TRUE)

object.size(census_municipality_geo)/1000000

state_list = unique(census_municipality_geo$state_name)

# create directory
dir.create("./data/mexico/census_geo/municipality")

for(i in 1:length(state_list)){
  
  state_i = state_list[i]
  print(i)
  print(length(state_list))
  # filter state
  census_municipality_geo_state = census_municipality_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./data/mexico/census_geo/municipality/",
                   state_i,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_municipality_geo_2020.geojson",
                    sep = "/")
  st_write(census_municipality_geo_state,
           file_path,
           delete_dsn = TRUE) 
  # upload to s3
  object_path = paste("mexico/census_geo/2020/municipality/",
                      state_i,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}



# create geojson with all states

census_municipality_geo_all = census_municipality_geo %>% 
  mutate(state_name = "All")

obj_size(census_municipality_geo_all)


census_municipality_geo_all_simpl <- st_simplify(census_municipality_geo_all, 
                                                 preserveTopology = TRUE, 
                                                 dTolerance = 100)

unique(st_geometry_type(census_municipality_geo_all_simpl, by_geometry = TRUE))

obj_size(census_municipality_geo_all_simpl)

# create dir
dir_path = paste("./data/mexico/census_geo/municipality/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_municipality_geo_2020.geojson",
                  sep = "/")
st_write(census_municipality_geo_all_simpl,
         file_path,
         delete_dsn = TRUE)
# upload to s3
object_path = paste("mexico/census_geo/2020/municipality/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


################## Locality level

# read census
census_state <- s3read_using(FUN = data.table::fread, 
                             object = "s3://cities-socio-economic-vulnerability/mexico/census/census_mexico_state_2020.csv")

census_locality = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/mexico/census/census_mexico_locality_2020.csv",
                                 sep = ",",
                                 encoding = "UTF-8",
                                 header = TRUE,
                                 colClasses = c('state_id'='character',
                                                'municipality_id'='character',
                                                'locality_id'='character'))

census_locality = census_locality %>% 
  unite(geo_id, c("state_id", "municipality_id","locality_id"), sep = "")



# read shapes
geo_locality <- s3read_using(FUN = sf::st_read, 
                          object = "s3://cities-socio-economic-vulnerability/mexico/boundaries/simplified/03_loc.geojson")


# merge
# census_locality_geo = geo_locality %>% 
#   left_join(census_locality,
#             by = c("NOMGEO" = "locality_name"),
#             keep = TRUE) %>% 
#   drop_na(locality_name) %>% 
#   distinct(NOMGEO,municipality_name, .keep_all= TRUE)

census_locality_geo = geo_locality %>% 
  left_join(census_locality,
            by = c("CVEGEO" = "geo_id"),
            keep = TRUE) %>% 
  drop_na(geo_id)

state_list = unique(census_locality_geo$state_name)

# create directory
dir.create("./data/mexico/census_geo/locality")

for(i in 1:length(state_list)){
  
  state_i = state_list[i]
  print(i)

  # filter state
  census_locality_geo_state = census_locality_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./data/mexico/census_geo/locality/",
                   state_i,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_locality_geo_2020.geojson",
                    sep = "/")
  st_write(census_locality_geo_state,
           file_path,
           delete_dsn = TRUE) 
  # upload to s3
  object_path = paste("mexico/census_geo/2020/locality/",
                      state_i,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}


