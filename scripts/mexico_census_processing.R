
################
# load raw data
################

wd_path = getwd()
# define data path

data_path = paste(wd_path, "/github/cities-socio-economic-vulnerability/data/raw/mexico", sep = "")

# find all file names ending in .csv 
files <- dir(data_path, pattern = "*.csv")

# read in those files and combine them into one data frame
census_mexico <- files %>%
  map(~ read_csv(file.path(data_path, .))) %>% # read in all the files individually, using the function read_csv() from the readr package
  reduce(rbind) # reduce with rbind into one dataframe


################################
# processing raw data ----
################################

census_mexico_mapped = census_mexico %>% 
  unite(block_id, AGEB, MZA, sep = "_", remove = FALSE) %>% 
  filter(MZA != "000") %>% 
  dplyr::select(state_id = ENTIDAD,
                state_name = NOM_ENT,
                municipality_id = MUN,
                municipality_name = NOM_MUN,
                locality_id = LOC,
                locality_name = NOM_LOC,
                ageb_id = AGEB,
                block_id,
                pop_total = POBTOT,
                pop_female = POBFEM,
                pop_male = POBMAS) %>% 
  mutate_at(c("pop_total","pop_female","pop_male"), as.numeric) 

################################
# Aggregating ----
################################

# state level
census_mexico_state = census_mexico_mapped %>% 
  group_by(state_name) %>% 
  dplyr::summarise(pop_total = sum(pop_total, na.rm = TRUE),
                   pop_female = sum(pop_female, na.rm = TRUE),
                   pop_male = sum(pop_male, na.rm = TRUE)) %>% 
  pivot_longer(!c(state_name),
               names_to = "variable",
               values_to = "value"
  ) %>% 
  add_column(year = "2020",
             entity_level = "state",
             municipality_name = NA,
             locality_name = NA) %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,variable,year,value)

census_mexico_state 

# state level
census_mexico_municipality= census_mexico_mapped %>% 
  group_by(state_name,municipality_name) %>% 
  dplyr::summarise(pop_total = sum(pop_total, na.rm = TRUE),
                   pop_female = sum(pop_female, na.rm = TRUE),
                   pop_male = sum(pop_male, na.rm = TRUE)) %>% 
  pivot_longer(!c(state_name,municipality_name),
               names_to = "variable",
               values_to = "value"
  ) %>% 
  add_column(year = "2020",
             entity_level = "municipality",
             locality_name = NA) %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,variable,year,value)

census_mexico_municipality 

# locality level
census_mexico_locality= census_mexico_mapped %>% 
  group_by(state_name,municipality_name,locality_name) %>% 
  dplyr::summarise(pop_total = sum(pop_total, na.rm = TRUE),
                   pop_female = sum(pop_female, na.rm = TRUE),
                   pop_male = sum(pop_male, na.rm = TRUE)) %>% 
  pivot_longer(!c(state_name,municipality_name,locality_name),
               names_to = "variable",
               values_to = "value"
  ) %>% 
  add_column(year = "2020",
             entity_level = "locality") %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,variable,year,value)

census_mexico_locality 

# ageb level
census_mexico_ageb = census_mexico_mapped %>% 
  group_by(state_name,municipality_name,locality_name, ageb_id) %>% 
  dplyr::summarise(pop_total = sum(pop_total, na.rm = TRUE),
                   pop_female = sum(pop_female, na.rm = TRUE),
                   pop_male = sum(pop_male, na.rm = TRUE)) %>% 
  pivot_longer(!c(state_name,municipality_name,locality_name, ageb_id),
               names_to = "variable",
               values_to = "value"
  ) %>% 
  add_column(year = "2020",
             entity_level = "ageb") %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,ageb_id,variable,year,value)

census_mexico_ageb 

# block level
census_mexico_block = census_mexico_mapped %>% 
  group_by(state_name,municipality_name,locality_name, ageb_id, block_id) %>% 
  dplyr::summarise(pop_total = sum(pop_total, na.rm = TRUE),
                   pop_female = sum(pop_female, na.rm = TRUE),
                   pop_male = sum(pop_male, na.rm = TRUE)) %>% 
  pivot_longer(!c(state_name,municipality_name,locality_name, ageb_id, block_id),
               names_to = "variable",
               values_to = "value"
  ) %>% 
  add_column(year = "2020",
             entity_level = "block") %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,ageb_id,block_id,variable,year,value)

census_mexico_block 

# bind

census_mexico_all_levels = census_mexico_state %>% 
  bind_rows(census_mexico_municipality,
            census_mexico_locality,
            census_mexico_ageb,
            census_mexico_block) %>% 
  dplyr::select('Level' = entity_level,
                'State' = state_name,
                'Municipality' = municipality_name,
                'Locality' = locality_name,
                'AGEB' = ageb_id,
                'Block' = block_id,
                'Variable' = variable,
                'Year' = year,
                'Value' = value)


##################
# store output ----
##################

data_output_path = paste(wd_path, "/github/cities-socio-economic-vulnerability/data/processed/census_mexico.csv", sep = "")
data_output_path = paste(wd_path, "/github/cities-socio-economic-vulnerability/app/socio-economic-vulnerability/data/census_mexico.csv", sep = "")

write.csv(census_mexico_all_levels,
          data_output_path,
          row.names = FALSE,
          fileEncoding = "UTF-8")