library(httr)
library(glue)
library(jsonlite)

mx_block_api <-
  "https://data-api.globalforestwatch.org/dataset/wri_mexico_block_socio_economic_vulnerability/v2020.1/query"

# Construct WHERE {state_name} AND {municipality_name}"
where_query <- function(select_query) {
  paste(
    select_query,
    glue(
      "WHERE state_name = 'Jalisco' AND municipality_name = 'Guadalajara'"
    )
  )
}

# Get total count of blocks per WHERE query
query_count <- "SELECT COUNT(gfw_fid) FROM result"
count_where <- where_query(query_count)
count_query <- list(sql = count_where)

api_count <- GET(mx_block_api, query = count_query)
res_count <- fromJSON(content(api_count, "text"))$data[[1]]

# Get starting gfw_fid for WHERE query
query_start <- "SELECT gfw_fid FROM result"
start_where <- where_query(query_start)
limit_start <- paste(
  start_where,
  "LIMIT 1"
)
limit_query <- list(sql = limit_start)
api_start <- GET(mx_block_api, query=limit_query)
block_start <- fromJSON(content(api_start, "text"))$data[[1]]
block_end <- res_start + res_count
block_chunks <- (block_end - block_start) %/% 1000

# Start of pagination query
query_compact <-
  "SELECT gfw_fid, entity_level, municipality_id, municipality_name, locality_id, locality_name, block_id, d_dwg, d_1rm, d_prop_1rm, d_2rms, d_prop_2rms, d_3mrms, d_prop_3mrms, d_mean_occup_r, d_1bedrm, d_prop_1bedrm, d_2mbedrms, d_prop_2mbedrms, d_dirtfloor, d_prop_dirtfloor, d_ntoil, d_prop_ntoil, d_ndrng, d_prop_ndrng, d_npwater, d_prop_npwater, d_nelect, d_prop_nelect, d_nbs, d_prop_nbs, d_ninet, d_prop_ninet, d_ncmp, d_prop_ncmp, d_ncp, d_prop_ncp, d_ntv, d_prop_ntv, d_nict, d_prop_nict, d_ncar, d_prop_ncar, d_mtrcl, d_prop_mtrcl, d_nmovh, d_prop_nmovh, d_bike, d_prop_bike, d_nrefri, d_prop_nrefri, d_nwm, d_prop_nwm, d_ngoods, d_prop_ngoods, p_tot, p_tot_m, p_tot_f, p_prop_m_f, p_0to2, p_0to2_f, p_0to2_m, p_3to5, p_3to5_f, p_3to5_m, p_6to11, p_6to11_f, p_6to11_m, p_12to14, p_12to14_f, p_12to14_m, p_15to17, p_15to17_f, p_15to17_m, p_18to24, p_18to24_f, p_18to24_m, p_25to59, p_25to59_f, p_25to59_m, p_60m, p_60m_f, p_60m_m, p_prop_tdr, p_prop_chddr, p_prop_olddr, p_mean_chdba, p_nhealth, p_prop_health, p_ilit, p_prop_ilit, p_ilit_f, p_prop_ilit_f, p_ilit_m, p_prop_ilit_m, p_6to11nas, p_prop_6to11nas, p_6to11nas_f, p_prop_6to11nas_f, p_6to11nas_m, p_prop_6to11nas_m, p_12to14nas, p_prop_12to14nas, p_12to14nas_f, p_prop_12to14nas_f, p_12to14nas_m, p_prop_12to14nas_m, p_15to17nas, p_prop_15to17nas, p_15to17nas_f, p_prop_15to17nas_f, p_15to17nas_m, p_prop_15to17nas_m, p_18to24nas, p_prop_18to24nas, p_18to24nas_f, p_prop_18to24nas_f, p_18to24nas_m, p_prop_18to24nas_m, p_mean_yredu, p_mean_yredu_f, p_mean_yredu_m, p_emp, p_emp_f, p_emp_m, p_unem, p_unem_f, p_unem_m, p_prop_emp, p_prop_emp_f, p_prop_emp_m, p_econia, p_econia_f, p_econia_m, p_hh, p_hh_f, p_prop_hh_f, p_hh_m, p_prop_hh_m, p_langindig, p_langindig_f, p_langindig_m, p_disab, p_disab_mtr, p_disab_vis, state_name, state_id, gfw_geojson, gfw_bbox FROM result"

# Query for starting FID of chunk
fid_greater <- function(select_query, fid_start) {
  paste(
    select_query,
    glue(
      "WHERE gfw_fid > {fid_start} LIMIT 1000"
    )
  )
}
block_query <- list(sql = fid_greater(query_compact, block_start))
block_res <- GET(mx_block_api, query = block_query)
content <-
  fromJSON(content(block_res, as = "text", encoding = "UTF-8"))$data
query_start <- block_start + 1000
for(i in 1:block_chunks) {
  chunk_query <- list(sql = fid_greater(query_compact, query_start))
  chunk_res <- GET(mx_block_api, query = block_query)
  chunk_content <- fromJSON(content(chunk_res, as = "text", encoding = "UTF-8"))$data
  content <- append(content, chunk_content)
  query_start <- query_start + 1000
  print(glue("Completed {i}th query!"))
}

bind_rows(content)