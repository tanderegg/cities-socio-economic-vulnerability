library(dplyr)
library(glue)
library(httr)
library(jsonlite)

# Query construction 
mx_block_api <-
  "https://data-api.globalforestwatch.org/dataset/wri_mexico_block_socio_economic_vulnerability/v2020.1/query"

block_query <-
  "SELECT gfw_fid, entity_level, municipality_id, municipality_name, locality_id, locality_name, block_id, d_dwg, d_1rm, d_prop_1rm, d_2rms, d_prop_2rms, d_3mrms, d_prop_3mrms, d_mean_occup_r, d_1bedrm, d_prop_1bedrm, d_2mbedrms, d_prop_2mbedrms, d_dirtfloor, d_prop_dirtfloor, d_ntoil, d_prop_ntoil, d_ndrng, d_prop_ndrng, d_npwater, d_prop_npwater, d_nelect, d_prop_nelect, d_nbs, d_prop_nbs, d_ninet, d_prop_ninet, d_ncmp, d_prop_ncmp, d_ncp, d_prop_ncp, d_ntv, d_prop_ntv, d_nict, d_prop_nict, d_ncar, d_prop_ncar, d_mtrcl, d_prop_mtrcl, d_nmovh, d_prop_nmovh, d_bike, d_prop_bike, d_nrefri, d_prop_nrefri, d_nwm, d_prop_nwm, d_ngoods, d_prop_ngoods, p_tot, p_tot_m, p_tot_f, p_prop_m_f, p_0to2, p_0to2_f, p_0to2_m, p_3to5, p_3to5_f, p_3to5_m, p_6to11, p_6to11_f, p_6to11_m, p_12to14, p_12to14_f, p_12to14_m, p_15to17, p_15to17_f, p_15to17_m, p_18to24, p_18to24_f, p_18to24_m, p_25to59, p_25to59_f, p_25to59_m, p_60m, p_60m_f, p_60m_m, p_prop_tdr, p_prop_chddr, p_prop_olddr, p_mean_chdba, p_nhealth, p_prop_health, p_ilit, p_prop_ilit, p_ilit_f, p_prop_ilit_f, p_ilit_m, p_prop_ilit_m, p_6to11nas, p_prop_6to11nas, p_6to11nas_f, p_prop_6to11nas_f, p_6to11nas_m, p_prop_6to11nas_m, p_12to14nas, p_prop_12to14nas, p_12to14nas_f, p_prop_12to14nas_f, p_12to14nas_m, p_prop_12to14nas_m, p_15to17nas, p_prop_15to17nas, p_15to17nas_f, p_prop_15to17nas_f, p_15to17nas_m, p_prop_15to17nas_m, p_18to24nas, p_prop_18to24nas, p_18to24nas_f, p_prop_18to24nas_f, p_18to24nas_m, p_prop_18to24nas_m, p_mean_yredu, p_mean_yredu_f, p_mean_yredu_m, p_emp, p_emp_f, p_emp_m, p_unem, p_unem_f, p_unem_m, p_prop_emp, p_prop_emp_f, p_prop_emp_m, p_econia, p_econia_f, p_econia_m, p_hh, p_hh_f, p_prop_hh_f, p_hh_m, p_prop_hh_m, p_langindig, p_langindig_f, p_langindig_m, p_disab, p_disab_mtr, p_disab_vis, state_name, state_id, gfw_geojson, gfw_bbox FROM result"

# Construct WHERE {state_name} AND {municipality_name}"
state_name <- "Baja California"
municipality_name <- "Mexicali"
  
where_query <-
  paste(
    block_query,
    glue(
      "WHERE state_name = '{state_name}' AND municipality_name = '{municipality_name}' LIMIT 1000"
    )
  )

# OFFSET query
offset_query <- function(query, offset) {
  paste(
    query,
    glue("OFFSET {offset}")
  )
}

offset <- 0
initial_query <- list(sql = where_query)

# GET Query
resp <- GET(mx_block_api, query = initial_query)
if(http_error(resp)) {
  print("Query error")
}
resp_content <-
  fromJSON(content(resp, as = "text", encoding = "UTF-8"))$data
payload <- resp_content

while (length(resp_content) > 0) {
  offset <- offset + 1000
  print(offset)
  next_page <- list(sql = offset_query(where_query, offset))
  resp <- GET(mx_block_api, query = next_page)
  if(http_error(resp)) {
    print("Query error")
    break
  }
  resp_content <-
    fromJSON(content(resp, as = "text", encoding = "UTF-8"))$data
  payload = (rbind(payload, resp_content))
  print(length(payload))
}

# Check if 200 response received