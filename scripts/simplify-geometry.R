################################################################################################
# This script is to simplify boundaries geometries in order to reduce the file size
################################################################################################

library(sp)
library(rgeos)
library(sf)
library(aws.s3)

##########################
# simplify states
##########################

# read shapes ----
geo_state <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_01_state.geojson")


# get state codes list ----
state_list = unique(geo_state$NOMGEO)
state_codes = unique(geo_state$CVEGEO)

##########################
# simplify municipalities
##########################

# read original file
geo_municipality = st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_02_municipality.geojson")

# compute file size
object.size(geo_municipality)/1000000

# get types of polygons to verify that we don't modify polygons types because of the simplification
unique(st_geometry_type(geo_municipality, by_geometry = TRUE))

# simplify by selecting a tolerance factor (test different factors the higher the tolerance more the geometry is simplified)
geo_municipality_simplified <- st_simplify(geo_municipality, 
                                          preserveTopology = TRUE, 
                                          dTolerance = 500)

# get types of polygons to verify that we don't modify polygons types because of the simplification
unique(st_geometry_type(geo_municipality_simplified, by_geometry = TRUE))

# compute output file size
object.size(geo_municipality_simplified)/1000000

# store simplified output
st_write(geo_municipality_simplified,
         "./data/dev/mexico/boundaries/boundary_02_municipality_simplified.geojson",
         delete_dsn = TRUE) 

# upload to s3
file_path = paste("./data/dev/mexico/boundaries/boundary_02_municipality_simplified.geojson")
object_path = paste("data/dev/mexico/boundaries/boundary_02_municipality_simplified.geojson")

put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

##########################
# simplify localities
##########################

# read original file
geo_locality = st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_03_locality.geojson")

# compute file size
object.size(geo_locality)/1000000

# get types of polygons to verify that we don't modify polygons types because of the simplification
unique(st_geometry_type(geo_locality, by_geometry = TRUE))

# simplify by selecting a tolerance factor (test different factors the higher the tolerance more the geometry is simplified)
geo_locality_simplified <- st_simplify(geo_municipality, 
                                           preserveTopology = TRUE, 
                                           dTolerance = 11)

# get types of polygons to verify that we don't modify polygons types because of the simplification
unique(st_geometry_type(geo_locality_simplified, by_geometry = TRUE))

# compute output file size
object.size(geo_locality_simplified)/1000000

# store simplified output
st_write(geo_locality_simplified,
         "./data/dev/mexico/boundaries/boundary_03_locality_simplified.geojson",
         delete_dsn = TRUE) 

# upload to s3
file_path = paste("./data/dev/mexico/boundaries/boundary_03_locality_simplified.geojson")
object_path = paste("data/dev/mexico/boundaries/boundary_03_locality_simplified.geojson")

put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

##########################
# simplify ageb
##########################

# read original file
geo_ageb = st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/boundary_04_ageb.geojson")

# compute file size
object.size(geo_ageb)/1000000

# get types of polygons to verify that we don't modify polygons types because of the simplification
unique(st_geometry_type(geo_ageb, by_geometry = TRUE))

# simplify by selecting a tolerance factor (test different factors the higher the tolerance more the geometry is simplified)
geo_ageb_simplified <- st_simplify(geo_ageb, 
                                   preserveTopology = TRUE, 
                                   dTolerance = 11)

# get types of polygons to verify that we don't modify polygons types because of the simplification
unique(st_geometry_type(geo_ageb_simplified, by_geometry = TRUE))

# compute output file size
object.size(geo_ageb_simplified)/1000000

# store simplified output
st_write(geo_ageb_simplified,
         "./data/dev/mexico/boundaries/boundary_04_geo_ageb_simplified.geojson",
         delete_dsn = TRUE) 

# upload to s3
file_path = paste("./data/dev/mexico/boundaries/boundary_04_geo_ageb_simplified.geojson")
object_path = paste("data/dev/mexico/boundaries/boundary_04_geo_ageb_simplified.geojson")

put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

##########################
# simplify block
##########################

# no possible simplification for existing files
